---
import SectorEditor from "@/components/admin/SectorEditor";
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createSupabaseServer } from "@/lib/supabase";

const sectorId = Astro.params.id ?? "";
const isNew = sectorId === "new";
const supabase = createSupabaseServer(Astro.cookies, Astro.request);

let sector: {
  id: string;
  name: string;
  description: string | null;
  platforms: string[];
  prompt_template: string | null;
} | undefined;
let categories: { id: string; name: string }[] = [];

if (!isNew) {
  const { data: sectorRes } = await supabase
    .from("business_sectors")
    .select("*")
    .eq("id", sectorId)
    .single();

  if (!sectorRes) {
    return Astro.redirect("/regia/sectors");
  }

  sector = {
    id: sectorRes.id,
    name: sectorRes.name ?? "",
    description: sectorRes.description ?? null,
    platforms: sectorRes.platforms ?? [],
    prompt_template: sectorRes.prompt_template ?? null,
  };

  const { data: categoriesRes } = await supabase
    .from("categories")
    .select("id, name")
    .eq("business_sector_id", sectorId)
    .order("name");

  categories = categoriesRes ?? [];
}
---

<AdminLayout title={isNew ? "Nuovo Settore" : "Modifica Settore"}>
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="/regia/sectors" class="text-gray-400 hover:text-gray-600">&larr;</a>
      <h1 class="text-2xl font-bold">
        {isNew ? "Nuovo Settore" : "Modifica Settore"}
      </h1>
    </div>
  </div>

  <SectorEditor
    client:load
    isNew={isNew}
    sector={sector}
    categories={categories}
  />
</AdminLayout>
