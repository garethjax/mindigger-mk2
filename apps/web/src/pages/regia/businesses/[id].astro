---
import AdminLayout from "@/layouts/AdminLayout.astro";
import BusinessDetailView from "@/components/admin/BusinessDetailView";
import { createSupabaseServer } from "@/lib/supabase";

const { id } = Astro.params;
const supabase = createSupabaseServer(Astro.cookies, Astro.request);

const { data: business } = await supabase
  .from("businesses")
  .select("*")
  .eq("id", id)
  .single();

if (!business) return Astro.redirect("/regia/businesses");

const [locationsRes, scrapingRes, sectorsRes, usersRes, reviewCountRes] = await Promise.all([
  supabase
    .from("locations")
    .select("id, name, is_competitor, business_sector_id, recurring_updates, created_at")
    .eq("business_id", id)
    .order("name"),
  supabase
    .from("scraping_configs")
    .select("id, location_id, platform, status, initial_scrape_done, last_scraped_at, platform_config")
    .in(
      "location_id",
      (await supabase.from("locations").select("id").eq("business_id", id)).data?.map((l) => l.id) ?? []
    ),
  supabase.from("business_sectors").select("id, name, platforms"),
  supabase.from("profiles").select("id, full_name").eq("business_id", id),
  supabase.from("reviews").select("id", { count: "exact" }).eq("business_id", id),
]);

const users = usersRes.data ?? [];
const usersLabel = users.length > 0
  ? users.map((u) => u.full_name || u.id.slice(0, 8)).join(", ")
  : "Nessun utente";

const googleMapsApiKey = import.meta.env.GOOGLE_MAPS_API_KEY ?? "";
---

<AdminLayout title={business.name}>
  <div class="mb-6 flex items-center gap-3">
    <a href="/regia/businesses" class="text-gray-400 hover:text-gray-600">&larr;</a>
    <h1 class="text-2xl font-bold">{business.name}</h1>
    <span class="text-sm text-gray-400">({business.type})</span>
  </div>

  <BusinessDetailView
    client:load
    business={business}
    locations={locationsRes.data ?? []}
    scrapingConfigs={scrapingRes.data ?? []}
    sectors={sectorsRes.data ?? []}
    usersLabel={usersLabel}
    reviewCount={reviewCountRes.count ?? 0}
    googleMapsApiKey={googleMapsApiKey}
  />
</AdminLayout>
