---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { createSupabaseServer } from "@/lib/supabase";

const supabase = createSupabaseServer(Astro.cookies, Astro.request);

// Fetch all profiles with their linked business
const { data: profiles } = await supabase
  .from("profiles")
  .select("id, role, full_name, business_id, account_enabled, account_locked, active_subscription, free_trial_consumed, created_at, businesses(id, name)")
  .order("created_at", { ascending: false });

const ROLE_LABELS: Record<string, { label: string; color: string }> = {
  admin: { label: "Admin", color: "bg-purple-100 text-purple-700" },
  business: { label: "Analista", color: "bg-blue-100 text-blue-700" },
};
---

<AdminLayout title="Utenti">
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-bold">Gestione Utenti</h1>
    <a
      href="/regia/users/create"
      class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
    >
      Nuovo Utente
    </a>
  </div>

  <div class="overflow-hidden rounded-lg border border-gray-200 bg-white">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Nome
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Ruolo
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Business
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Stato
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Abbonamento
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500">
            Registrato
          </th>
          <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wide text-gray-500">
            Azioni
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {(profiles ?? []).map((p) => {
          const role = ROLE_LABELS[p.role] ?? ROLE_LABELS.business;
          const biz = p.businesses as unknown as { id: string; name: string } | null;
          const isDisabled = !p.account_enabled || p.account_locked;
          return (
            <tr class={isDisabled ? "bg-gray-50 opacity-60" : ""}>
              <td class="px-4 py-3">
                <div class="text-sm font-medium text-gray-900">
                  {p.full_name || "\u2014"}
                </div>
                {!p.full_name && <div class="text-xs text-gray-400">{p.id.slice(0, 8)}\u2026</div>}
              </td>
              <td class="px-4 py-3">
                <span class={`rounded-full px-2 py-0.5 text-xs font-medium ${role.color}`}>
                  {role.label}
                </span>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600">
                {biz ? biz.name : "\u2014"}
              </td>
              <td class="px-4 py-3">
                {p.account_locked ? (
                  <span class="rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-700">
                    Bloccato
                  </span>
                ) : !p.account_enabled ? (
                  <span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">
                    Disabilitato
                  </span>
                ) : (
                  <span class="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                    Attivo
                  </span>
                )}
              </td>
              <td class="px-4 py-3">
                {p.active_subscription ? (
                  <span class="text-xs font-medium text-green-600">Attivo</span>
                ) : p.free_trial_consumed ? (
                  <span class="text-xs text-gray-400">Trial esaurito</span>
                ) : (
                  <span class="text-xs text-yellow-600">Free trial</span>
                )}
              </td>
              <td class="px-4 py-3 text-xs text-gray-500">
                {new Date(p.created_at).toLocaleDateString("it-IT")}
              </td>
              <td class="px-4 py-3 text-right">
                <a
                  href={`/regia/users/${p.id}`}
                  class="text-sm font-medium text-blue-600 hover:text-blue-800"
                >
                  Gestisci
                </a>
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
    {(!profiles || profiles.length === 0) && (
      <div class="p-8 text-center text-sm text-gray-500">
        Nessun utente trovato.
      </div>
    )}
  </div>
</AdminLayout>
