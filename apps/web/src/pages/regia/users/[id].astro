---
import AdminLayout from "@/layouts/AdminLayout.astro";
import UserEditForm from "@/components/admin/UserEditForm";
import { createSupabaseServer } from "@/lib/supabase";

const { id } = Astro.params;
const supabase = createSupabaseServer(Astro.cookies, Astro.request);

const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", id)
  .single();

if (!profile) return Astro.redirect("/regia/users");

const { data: businesses } = await supabase
  .from("businesses")
  .select("id, name, user_id")
  .eq("user_id", id);

const { data: allBusinesses } = await supabase
  .from("businesses")
  .select("id, name, user_id")
  .order("name");
---

<AdminLayout title="Modifica Utente">
  <div class="mb-6 flex items-center gap-3">
    <a href="/regia/users" class="text-gray-400 hover:text-gray-600">&larr;</a>
    <h1 class="text-2xl font-bold">
      {profile.full_name || "Utente"}
    </h1>
    <span class="text-sm text-gray-400">{id?.slice(0, 8)}â€¦</span>
  </div>

  <div class="max-w-lg">
    <UserEditForm
      client:load
      profile={profile}
      userBusinesses={businesses ?? []}
      allBusinesses={allBusinesses ?? []}
    />
  </div>
</AdminLayout>
