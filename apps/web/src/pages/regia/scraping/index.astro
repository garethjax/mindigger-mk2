---
import AdminLayout from "@/layouts/AdminLayout.astro";
import ScrapingDashboard from "@/components/admin/ScrapingDashboard";
import { createSupabaseServer } from "@/lib/supabase";

const supabase = createSupabaseServer(Astro.cookies, Astro.request);

// Fetch all scraping configs with location + business info
const { data: configs } = await supabase
  .from("scraping_configs")
  .select(`
    id, platform, status, bot_id, initial_scrape_done,
    initial_depth, recurring_depth, frequency,
    retry_count, last_error, last_scraped_at, next_poll_at, updated_at,
    locations(id, name, is_competitor, businesses(id, name, user_id))
  `)
  .order("updated_at", { ascending: false });

// Get profile names for owners
const userIds = [
  ...new Set(
    (configs ?? [])
      .map((c: any) => c.locations?.businesses?.user_id)
      .filter(Boolean)
  ),
];
const { data: profiles } = userIds.length > 0
  ? await supabase.from("profiles").select("id, full_name").in("id", userIds)
  : { data: [] };

const profileMap = Object.fromEntries(
  (profiles ?? []).map((p) => [p.id, p.full_name ?? p.id.slice(0, 8)])
);
---

<AdminLayout title="Scraping">
  <h1 class="mb-6 text-2xl font-bold">Status Scraping</h1>
  <ScrapingDashboard
    client:load
    configs={(configs ?? []) as any}
    profileMap={profileMap}
  />
</AdminLayout>
