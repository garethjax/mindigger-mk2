---
import AdminLayout from "@/layouts/AdminLayout.astro";
import AIConfigPanel from "@/components/admin/AIConfigPanel";
import { createSupabaseServer } from "@/lib/supabase";

const supabase = createSupabaseServer(Astro.cookies, Astro.request);

const [configsRes, tokenRes, batchesRes, pricingRes, balanceRes] = await Promise.all([
  supabase.from("ai_configs").select("*").order("created_at"),
  supabase
    .from("token_usage")
    .select("business_id, provider, model, batch_type, prompt_tokens, completion_tokens, total_tokens, cached_tokens, date, businesses(name)")
    .order("date", { ascending: false })
    .limit(500),
  supabase
    .from("ai_batches")
    .select("id, external_batch_id, provider, batch_type, status, created_at, updated_at")
    .order("created_at", { ascending: false })
    .limit(50),
  supabase
    .from("ai_pricing")
    .select("*")
    .eq("is_active", true),
  supabase
    .from("ai_credit_balance")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(1)
    .single(),
]);
---

<AdminLayout title="AI Config">
  <h1 class="mb-6 text-2xl font-bold">Configurazione AI</h1>
  <AIConfigPanel
    client:load
    configs={configsRes.data ?? []}
    tokenUsage={(tokenRes.data ?? []) as any}
    batches={batchesRes.data ?? []}
    pricing={(pricingRes.data ?? []) as any}
    creditBalance={balanceRes.data as any}
  />
</AdminLayout>
