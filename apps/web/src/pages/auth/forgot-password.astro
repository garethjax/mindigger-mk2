---
import BaseLayout from "@/layouts/BaseLayout.astro";
---

<BaseLayout title="Reset Password">
  <div class="flex min-h-screen items-center justify-center">
    <div class="w-full max-w-sm space-y-6 rounded-xl bg-white p-8 shadow-lg">
      <div class="text-center">
        <h1 class="text-2xl font-bold">Reset Password</h1>
        <p class="mt-1 text-sm text-gray-500">
          Inserisci la tua email per ricevere il link di reset
        </p>
      </div>

      <div id="reset-form">
        <form id="forgot-form" class="space-y-3">
          <div>
            <label for="email" class="mb-1 block text-sm font-medium text-gray-700">Email</label>
            <input
              id="email"
              type="email"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="nome@esempio.it"
            />
          </div>
          <button
            type="submit"
            class="w-full rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50"
          >
            Invia Link di Reset
          </button>
        </form>
        <div id="reset-message" class="mt-3 hidden rounded-lg p-3 text-sm"></div>
      </div>

      <p class="text-center text-xs text-gray-500">
        <a href="/auth/login" class="text-blue-600 hover:underline">Torna al login</a>
      </p>
    </div>
  </div>
</BaseLayout>

<script>
  import { createSupabaseBrowser } from "@/lib/supabase";

  const form = document.getElementById("forgot-form") as HTMLFormElement;
  const msgDiv = document.getElementById("reset-message") as HTMLDivElement;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = (document.getElementById("email") as HTMLInputElement).value;
    const btn = form.querySelector("button") as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = "...";

    const supabase = createSupabaseBrowser();
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/auth/callback`,
    });

    msgDiv.classList.remove("hidden", "bg-red-50", "text-red-700", "bg-green-50", "text-green-700");

    if (error) {
      msgDiv.classList.add("bg-red-50", "text-red-700");
      msgDiv.textContent = "Errore nell'invio. Riprova.";
    } else {
      msgDiv.classList.add("bg-green-50", "text-green-700");
      msgDiv.textContent = "Email inviata! Controlla la tua casella.";
    }

    btn.disabled = false;
    btn.textContent = "Invia Link di Reset";
  });
</script>
