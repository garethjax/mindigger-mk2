---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import Dashboard from "@/components/dashboard/Dashboard";
import { createSupabaseServer } from "@/lib/supabase";

const supabase = createSupabaseServer(Astro.cookies, Astro.request);
const profile = Astro.locals.profile;
const businessId = profile?.business_id;

const { data: locations } = businessId
  ? await supabase
      .from("locations")
      .select("id, name, is_competitor, business_sector_id")
      .eq("business_id", businessId)
      .order("name")
  : { data: [] };

// Get distinct sector IDs from the business's locations, then fetch matching categories
const sectorIds = [...new Set((locations ?? []).map((l) => l.business_sector_id))];
const { data: categories } = sectorIds.length > 0
  ? await supabase
      .from("categories")
      .select("id, name")
      .in("business_sector_id", sectorIds)
      .order("name")
  : { data: [] };
---

<DashboardLayout title="Analytics">
  <h1 class="mb-6 text-2xl font-bold">Analytics</h1>
  {businessId && locations && locations.length > 0 ? (
    <Dashboard
      client:load
      locations={locations}
      categories={categories ?? []}
      businessId={businessId}
      isCompetitor={false}
    />
  ) : (
    <div class="rounded-lg border border-gray-200 bg-white p-8 text-center text-gray-500">
      <p class="text-lg font-medium">Nessuna location configurata</p>
      <p class="mt-1 text-sm">Contatta l'amministratore per configurare le tue location.</p>
    </div>
  )}
</DashboardLayout>
