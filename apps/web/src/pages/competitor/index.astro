---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import Dashboard from "@/components/dashboard/Dashboard";
import { createSupabaseServer } from "@/lib/supabase";

const supabase = createSupabaseServer(Astro.cookies, Astro.request);
const user = Astro.locals.user;

const { data: businesses } = await supabase
  .from("businesses")
  .select("id")
  .eq("user_id", user.id);

const businessIds = businesses?.map((b) => b.id) ?? [];

const { data: locations } = await supabase
  .from("locations")
  .select("id, name, is_competitor")
  .in("business_id", businessIds)
  .eq("is_competitor", true)
  .order("name");
---

<DashboardLayout title="Competitor">
  <h1 class="mb-6 text-2xl font-bold">Analisi Competitor</h1>
  {locations && locations.length > 0 ? (
    <Dashboard client:load locations={locations} isCompetitor={true} />
  ) : (
    <div class="rounded-lg border border-gray-200 bg-white p-8 text-center text-gray-500">
      <p class="text-lg font-medium">Nessun competitor configurato</p>
      <p class="mt-1 text-sm">Contatta l'amministratore per aggiungere location competitor.</p>
    </div>
  )}
</DashboardLayout>
